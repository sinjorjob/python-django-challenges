<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>POSシステム</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <style type="text/css">
      textarea {
        margin-left: 5px;
          border-radius: 10px;
          background-color: rgb(245, 243, 241);
        }
    </style>
  </head>
  <body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">商品注文POSシステム</a>
      </div>
    </nav>
    <!-- Masthead-->
    <header class="masthead bg-primary text-white text-center">
      <div class="container d-flex align-items-center flex-column">
        <!-- Masthead Avatar Image-->
        <img class="masthead-avatar mb-5" src="assets/img/avataaars.svg" alt="..." />
        <!-- Masthead Heading-->
        <h1 class="masthead-heading text-uppercase mb-0">いらっしゃいませ！</h1>
      </div>
    </header>
    <!-- Portfolio Section-->
    <section class="page-section portfolio" id="portfolio">
      <div class="container">
        <!-- Portfolio Section Heading-->
        <h2 class="page-section-heading text-center text-uppercase text-secondary mb-0">商品のオーダー</h2>
        <!-- Icon Divider-->
        <div class="divider-custom">
          <div class="divider-custom-line"></div>
          <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
          <div class="divider-custom-line"></div>
        </div>
        <!-- Portfolio Grid Items-->
        <div class="row justify-content-center">
          <!-- Portfolio Item 1-->
          <div class="col-md-6 col-lg-4 mb-5">
            <div class="portfolio-item mx-auto" data-toggle="modal" data-target="#portfolioModal1">
              <div class="portfolio-item-caption d-flex align-items-center justify-content-center h-100 w-100">
                <div class="portfolio-item-caption-content text-center text-white"><i class="fas fa-plus fa-3x"></i>
                  <h2>商品追加はこちら</h2>
                </div>
              </div>
              <img class="img-fluid" src="assets/img/portfolio/cake.png" alt="..." />
            </div>
          </div>
          <!-- Portfolio Item 2-->
          <div class="col-md-6 col-lg-4 mb-5">
            <div class="portfolio-item mx-auto" data-toggle="modal" data-target="#portfolioModal2">
              <div class="portfolio-item-caption d-flex align-items-center justify-content-center h-100 w-100">
                <div class="portfolio-item-caption-content text-center text-white"><i class="fas fa-cash-register fa-3x"></i>
                  <h2>お会計はこちら</h2></div>
                </div>
                <img class="img-fluid" src="assets/img/portfolio/calculator.jpg" alt="..." />
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- About Section-->
      <!-- Contact Section-->
      <section class="page-section" id="contact">
        <div class="container">
          <!-- Contact Section Heading-->
          <h2 class="text-left text-secondary mb-0">注文リスト</h2>
          <!-- Icon Divider-->
          <div class="divider-custom">
            <button class="btn btn-primary" data-dismiss="modal" onclick="init_order_list()">注文をリセット</button>
          </div>
          <textarea id ="item_list" rows="15" cols="120"></textarea>
          <!-- Contact Section Form-->
          <div id ="total_amount">
          <!--ここに合計金額を非同期で表示-->
          </div>
        </div>
      </section>
      <!-- Copyright Section-->
      <div class="copyright py-4 text-center text-white">
        <div class="container">
          <small>
            Copyright &copy; Your Website
            <!-- This script automatically adds the current year to your website footer-->
            <!-- (credit: https://updateyourfooter.com/)-->
            <script>
              document.write(new Date().getFullYear());
            </script>
          </small>
        </div>
      </div>
      <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes)-->
      <div class="scroll-to-top d-lg-none position-fixed">
        <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top"><i class="fa fa-chevron-up"></i></a>
      </div>
      <!-- Portfolio Modals-->
      <!-- Portfolio Modal 1-->
      <div class="portfolio-modal modal fade" id="portfolioModal1" tabindex="-1" role="dialog" aria-labelledby="portfolioModal1Label" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
          <div class="modal-content">
            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true"><i class="fas fa-times"></i></span>
            </button>
            <div class="modal-body text-center">
              <div class="container">
                <div class="row justify-content-center">
                  <div class="col-lg-8">
                    <!-- Portfolio Modal - Title-->
                    <h2 class="portfolio-modal-title text-secondary text-uppercase mb-0" id="portfolioModal1Label">入力フォーム</h2>
                    <!-- Icon Divider-->
                    <div class="divider-custom">
                      <div class="divider-custom-line"></div>
                      <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                      <div class="divider-custom-line"></div>
                    </div>
                    <!-- Portfolio Modal - Image-->
                    <!--<img class="img-fluid rounded mb-5" src="assets/img/portfolio/cabin.png" alt="..." />-->
                    <!-- Portfolio Modal - Text-->
                    <table class="table table-striped table-bordered">
                      <thead>
                        <tr>
                          <th scope="col">商品コード</th>
                          <th scope="col">商品名</th>
                          <th scope="col">価格</th>
                        </tr>
                      </thead>
                      <tbody id='data-table'>
                       <!-- ここに商品情報を埋め込む--> 
                      </tbody>
                    </table>
                    <!-- ###############  商品入力フォーム ここから  ############## -->
                    <section class="page-section" id="contact">
                      <div class="container">
                        <!-- Contact Section Form-->
                        <div class="row">
                          <div class="col-lg-8 mx-auto">
                            <!-- To configure the contact form email address, go to mail/contact_me.php and update the email address in the PHP file on line 19.-->
                            <form id="contactForm">
                              <div class="control-group">
                                <div class="form-group floating-label-form-group mb-0 pb-2">
                                  <label>商品コード</label>
                                  <input class="form-control" id="item_code" type="text" placeholder="商品コード" />
                                </div>
                              </div>
                              <div class="control-group">
                                <div class="form-group floating-label-form-group mb-0 pb-2">
                                  <label>数量</label>
                                  <input class="form-control" id="item_count" type="text" placeholder="注文数"/>
                                </div>
                              </div>
                              <br />
                              <div id="success"></div>
                              <input type="submit" class="form-group btn btn-primary btn-xl" value="オーダーリストに追加する" onclick="add_item()">
                            </form>
                          </div>
                        </div>
                      </div>
                    </section>
                     <!-- ###############  商品入力フォーム ここまで  ############## -->
                     <button class="btn btn-primary" data-dismiss="modal">
                       <i class="fas fa-times fa-fw"></i>画面を閉じる</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Portfolio Modal 2-->
          <div class="portfolio-modal modal fade" id="portfolioModal2" tabindex="-1" role="dialog" aria-labelledby="portfolioModal2Label" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
              <div class="modal-content">
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true"><i class="fas fa-times"></i></span></button>
                  <div class="modal-body text-center">
                    <div class="container">
                      <div class="row justify-content-center">
                        <div class="col-lg-8">
                          <!-- Portfolio Modal - Title-->
                          <h2 class="portfolio-modal-title text-secondary text-uppercase mb-0" id="portfolioModal2Label">お会計処理</h2>
                          <!-- Icon Divider-->
                          <div class="divider-custom">
                            <div class="divider-custom-line"></div>
                            <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                            <div class="divider-custom-line"></div>
                          </div>
                          <!-- Portfolio Modal - Image-->
                          <!-- Portfolio Modal - Text-->
                          <p class="mb-5">支払金額を入力して購入ボタンを押してください。</p>
                          <div id ="total_amount2">
                            <!--ここに合計金額を非同期で表示-->
                          </div>
                          <!-- ここに支払金額フォームと購入ボタンを表示-->
                          <form id="contactForm" name="sentMessage" novalidate="novalidate">
                            <div class="control-group">
                              <div class="form-group floating-label-form-group controls mb-0 pb-2">
                                <label>支払金額</label>
                                <input class="form-control" id="payment" type="text" placeholder="支払金額" />
                                <p class="help-block text-danger"></p>
                              </div>
                            </div>
                            <br />
                            <div id="success"></div>
                            <input type="submit" class="form-group btn btn-primary btn-xl" value="購入する" onclick="calc_payment()">
                          </form>
                          <div id ="payment_result">
                            <!-- ここに購入結果を非同期で表示する-->
                          </div>
                          <button class="btn btn-primary" data-dismiss="modal" onclick="init_payment_result()">
                            <i class="fas fa-times fa-fw"></i>画面を閉じる</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Bootstrap core JS-->
              <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
              <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
              <!-- Third party plugin JS-->
              <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
              <!-- Contact form JS-->
              <script src="assets/mail/jqBootstrapValidation.js"></script>
              <script src="assets/mail/contact_me.js"></script>
              <!-- Core theme JS-->
              <script src="js/scripts.js"></script>
              <!-- sweetalertでアラートメッセージを装飾 -->
              <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
              
              
              <!-- eel script -->
              <script type="text/javascript" src="eel.js"></script>
              <script>
                 
                /************* 注文リストに追加**************/  
                function add_item() {
                  let item_code = document.getElementById('item_code').value;
                  let item_count = document.getElementById('item_count').value;
                  if (item_code == null || item_count == '') {
                    swal({
                      title: '商品コードまたは数量が入力されていません。',
                      text: '',
                      icon: 'error',
                      button: 'OK'});
                    }else{ 
                      async function run() {
                        let result = await eel.add_item(item_code, item_count)();
                        if (Object.keys(result).length == 2){
                          swal({
                            title: 'エラーが発生しました。',
                            text: result.message,
                            icon: 'error',
                            button: 'OK'});
                          //フォームのクリア
                          document.getElementById("item_code").value = '';
                          document.getElementById("item_count").value = '';
                        }else{
                          let textarea = document.getElementById('item_list');
                          textarea.innerHTML = "";  /*内容を一旦クリア*/
                          /* textareaにメッセージを表示*/
                          for ( let i = 0; i < result[0].length; i ++ ) {
                            textarea.insertAdjacentHTML('beforeend', result[0][i] + "\n");
                          }
                          document.getElementById('total_amount').innerHTML = "<p><b><font color='red'>合計金額：" + result[1] + "円</font></b></p>";
                          document.getElementById('total_amount2').innerHTML = "<p><b><font color='red'>合計金額：" + result[1] + "円</font></b></p>";
                          swal({
                            title: '商品が追加されました。',
                            text: '',
                            icon: 'success',
                            button: 'OK'});
                          //フォームのクリア
                          document.getElementById("item_code").value = '';
                          document.getElementById("item_count").value = '';
                        } /*end else */
                      }  /* end async function */
                      run();
                    }
                  }  /* end add_item() */
                  
                /*************    商品情報取得 **************/  
                function get_item_info() {
                  let item_code = document.getElementById('item_code').value;
                  async function run() {
                    let result = await eel.get_item_info()();
                    /*テーブルの初期化*/
                    //親要素取得
                    let parent = document.getElementById('data-table');
                    //tbody配下の子要素をすべて削除
                    while(parent.lastChild){
                      parent.removeChild(parent.lastChild);
                    }
                    var tableEle = document.getElementById('data-table');
                    for (var i = 0;  i < result[0].length; i++) {
                      // テーブルの行追加する
                      var tr = document.createElement('tr');
                      for (var j = 0; j < 3; j++) {
                        // テーブルの列を 3行追加する
                        var td = document.createElement('td');
                        td.innerHTML = result[j][i];
                        tr.appendChild(td);
                      } /* end for */
                      tableEle.appendChild(tr);
                    } /* end for */
                  }  /* end async function */
                  run();
                }  /* end get_item_info() */



                /*************    会計処理  **************/
                function calc_payment() {
                  let payment = document.getElementById('payment').value;
                  if (payment == "") {
                    swal({
                      title: '支払金額が入力されていません。',
                      text: '',
                      icon: 'error',
                      button: 'OK'});
                    }else{
                      async function run() {
                        let result = await eel.payment(payment)();
                        /*処理結果タイプによってメッセージ種別を切り替える*/
                        if (result.type == "error"){
                          swal({
                            title: 'エラーが発生しました。',
                            text: result.message,
                            icon: 'error',
                            button: 'OK'});
                            /*支払金額フォームのクリア*/
                          paymentForm = document.getElementById("payment").value = '';
                        }else{
                          /*正常終了した処理結果を表示*/
                          document.getElementById('payment_result').innerHTML = "<p><b>" + result.message + "</b></p>";
                          //フォームのクリア
                          document.getElementById("payment").value = '';
                          document.getElementById("total_amount2").innerHTML = '';
                          init_order_list()  //注文リスト、合計金額等をリセット
                        }
                      }  /* end async function */
                      run();
                    }  /* end else */
                  }  /* end payment() */


                /*************    オーダ状況のチェック処理  **************/
                function chk_order_status() {
                  async function run() {
                    let result = await eel.chk_order_status()();
                    if (result.type == "error"){
                      swal({
                        title: 'エラーが発生しました。',
                        text: result.message,
                        icon: 'error',
                        button: 'OK'});
                      } /* end if */
                     }  /* end async function */
                     run();
                    }  /* endchk_order_status() */
                
                /*************    注文リストのリセット  **************/
                function init_order_list() {
                  async function run() {
                    let result = await eel.init_order_list()();
                    /*textareaのリセット*/
                    document.getElementById('item_list').innerHTML = "";
                    /*合計金額欄をリセット*/
                    document.getElementById("total_amount").innerHTML = '';
                    document.getElementById("total_amount2").innerHTML = '';
                  }  /* end async function */
                  run();
                }  /* end init_order_list() */
              </script>
              
              
              <script>
                $(function () {
                  $('#portfolioModal1').on('show.bs.modal', function (event) {
                    get_item_info();
                  });    
                });

                $(function () {
                    $('#portfolioModal2').on('show.bs.modal', function (event) {
                      chk_order_status();
                    });    
                });

                function init_payment_result(){
                    /*会計結果欄をリセット*/
                    document.getElementById('payment_result').innerHTML = "";
                }
              </script>
            
</body>
</html>